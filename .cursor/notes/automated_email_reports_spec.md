# Technical Specification: Automated Email Reports

**Goal:** Schedule and automatically email weekly and monthly summary reports using Zapier and Gmail, generated by the existing Python logic.

**Components:**

1.  **Python API Server (FastAPI):**
    *   **Purpose:** Acts as a bridge between Zapier and the report generation code.
    *   **Framework:** FastAPI (requires adding `fastapi` and `uvicorn` to `requirements.txt`).
    *   **Endpoint:** `/generate_report` (GET or POST).
        *   Accepts a query parameter `timespan` (`weekly` or `monthly`).
        *   Calculates the appropriate `start_timestamp` based on the `timespan` (e.g., start of last week, start of last month in UTC).
        *   Retrieves the relevant `app_id` (Needs clarification: Should this be hardcoded, an environment variable, or passed as another parameter?).
        *   Calls the existing `generate_summary_report(app_id, start_timestamp)` function.
    *   **File Generation:** Generates the Excel report bytes in memory.
    *   **Cloud Storage Integration (R2):**
        *   Uses `boto3` library (requires adding to `requirements.txt`).
        *   Requires R2 credentials (Endpoint URL, Bucket Name, Access Key ID, Secret Access Key) configured securely via environment variables (e.g., `.env` file).
        *   Uploads the generated Excel bytes to the configured R2 bucket.
        *   Generates a filename including app ID, timespan, and timestamp (e.g., `steam_report_3228590_weekly_20240505.xlsx`).
        *   Generates a pre-signed URL for the uploaded R2 object with a suitable expiry (e.g., 1-2 hours).
    *   **API Response:** Returns a JSON response containing the pre-signed URL: `{"report_url": "https://<r2-presigned-url>..."}`.
    *   **Deployment:** Needs to be deployed on a server/service reachable by Zapier.

2.  **Cloudflare R2:**
    *   **Purpose:** Store the generated Excel reports temporarily.
    *   **Configuration:** Set up an R2 bucket. Obtain Endpoint URL, Bucket Name, Access Key ID, and Secret Access Key.

3.  **Zapier Workflow:**
    *   **Trigger:** Schedule by Zapier (Configure two Zaps: one weekly, one monthly).
    *   **Action 1:** Webhooks by Zapier - `GET` (or `POST`).
        *   Target URL: The deployed FastAPI endpoint (`/generate_report`).
        *   Query String Params: `timespan=weekly` (for the weekly Zap) or `timespan=monthly` (for the monthly Zap). (Add `app_id` if needed).
        *   This action triggers the report generation and receives the JSON response with the `report_url`.
    *   **Action 2:** Webhooks by Zapier - `GET`.
        *   Target URL: Use the `report_url` value captured from Action 1.
        *   This action downloads the report file from the R2 pre-signed URL. Zapier should make this file available to subsequent steps.
    *   **Action 3:** Gmail - Send Email.
        *   Connect your Gmail account.
        *   Configure recipient(s), subject (e.g., "Weekly Steam Review Summary"), body.
        *   Attach the file downloaded in Action 2.

**Security Considerations:**

*   Securely manage R2 credentials using environment variables on the API server.
*   Ensure the API endpoint is appropriately secured if deployed publicly (e.g., using an API key check passed from Zapier).
*   Set a reasonable expiry time for R2 pre-signed URLs.

**Open Questions:**

*   How should the `app_id` be provided to the API endpoint? (Hardcoded, env var, query param?) Assuming only one app is tracked by this instance, an environment variable seems simplest.
*   Error handling: How should the API and Zap respond if report generation fails? (API returns error JSON, Zapier stops or sends a notification email).

**Dependencies to Add:**

*   `fastapi`
*   `uvicorn[standard]` (for running FastAPI)
*   `boto3`

**Next Steps (When Resumed):**

1.  Add dependencies to `requirements.txt`.
2.  Create `api_server.py` with FastAPI setup.
3.  Implement the `/generate_report` endpoint logic.
4.  Implement R2 upload and pre-signed URL generation.
5.  Configure environment variables for R2.
6.  Deploy the API server.
7.  Set up the Zapier workflows. 